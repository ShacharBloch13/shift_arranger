<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Availability</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script>
let currentAssignment = null; // Store the current assignment globally

async function submitAvailability() {
    let availabilities = [];
    document.querySelectorAll('.availability').forEach((checkbox) => {
        let [worker, day, shift] = checkbox.id.split('_');
        availabilities.push({
            worker: worker,
            day: day,
            shift: shift,
            available: checkbox.checked
        });
    });
    let response = await fetch('/availability', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(availabilities)
    });
    let result = await response.json();
    if (result.error) {
        alert(result.error);
    } else {
        alert(result.status);
    }
}

async function getAssignments() {
    let response = await fetch('/assignments');
    let result = await response.json();
    if (result.error) {
        alert(result.error);
    } else {
        currentAssignment = result; // Store the fetched assignment and score
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const shifts = ["07:00-15:00", "15:00-23:00", "23:00-07:00"];

        let assignmentsTable = '<table border="1"><thead><tr><th>Shift/Day</th>';
        days.forEach(day => {
            assignmentsTable += `<th>${day}</th>`;
        });
        assignmentsTable += '</tr></thead><tbody>';

        shifts.forEach(shift => {
            assignmentsTable += `<tr><td>${shift}</td>`;
            days.forEach(day => {
                let worker = result.assignments[`${day} ${shift}`] || '';
                if (worker) {
                    assignmentsTable += `<td class="assignment-cell"><span class="${worker.toLowerCase()}">${worker}</span></td>`;
                } else {
                    assignmentsTable += `<td class="assignment-cell"></td>`;
                }
            });
            assignmentsTable += '</tr>';
        });
        assignmentsTable += '</tbody></table>';

        document.getElementById('assignments').innerHTML = assignmentsTable;
        document.getElementById('score').innerText = 'Score: ' + result.score;
        document.getElementById('acceptButton').style.display = 'block'; // Show the accept button
    }
}

async function acceptAssignment() {
    if (!currentAssignment) {
        alert("No assignment to accept.");
        return;
    }

    let response = await fetch('/assignments/accept', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(currentAssignment)
    });

    let result = await response.json();
    if (result.success) {
        alert("Assignment accepted and saved!");
        document.getElementById('assignments').innerHTML = ''; // Clear the assignment
        document.getElementById('score').innerText = '';
        document.getElementById('acceptButton').style.display = 'none'; // Hide the accept button
        currentAssignment = null; // Reset the assignment
    } else {
        alert("Error: " + result.error);
    }
}
    </script>
</head>
<body>
    <h1>Shift Availability</h1>
    <form onsubmit="event.preventDefault(); submitAvailability();">
        <script>
            const workers = ["Worker1", "Worker2", "Worker3", "Worker4", "Worker5", "Worker6", "Worker7"];
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const shifts = ["07:00-15:00", "15:00-23:00", "23:00-07:00"];
            
            workers.forEach(worker => {
                document.write(`<h2 class="worker-title ${worker.toLowerCase()}">${worker}</h2>`);
                document.write('<table border="1"><thead><tr><th>Shift/Day</th>');
                days.forEach(day => {
                    document.write(`<th>${day}</th>`);
                });
                document.write('</tr></thead><tbody>');
                shifts.forEach(shift => {
                    document.write(`<tr><td>${shift}</td>`);
                    days.forEach(day => {
                        document.write(`<td><input type="checkbox" id="${worker}_${day}_${shift}" class="availability"></td>`);
                    });
                    document.write('</tr>');
                });
                document.write('</tbody></table>');
            });
        </script>
        <button type="submit">Submit Availability</button>
    </form>
    <button onclick="getAssignments()">Get Assignments</button>
    <button id="acceptButton" onclick="acceptAssignment()" style="display:none;">Accept Assignment</button>

    <h2>Assignments</h2>
    <div id="assignments"></div>
    <p id="score"></p>
</body>
</html>
