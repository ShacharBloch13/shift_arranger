<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Availability</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script>
        let currentAssignmentIndex = 0;
        let assignmentsList = [];
        let currentAssignment = null; // Store the current assignment globally
        
        async function submitAvailability() {
            let availabilities = [];
            document.querySelectorAll('.availability').forEach((checkbox) => {
                let [worker, day, shift] = checkbox.id.split('_');
                availabilities.push({
                    worker: worker,
                    day: day,
                    shift: shift,
                    available: checkbox.checked
                });
            });
            let response = await fetch('/availability', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(availabilities)
            });
            let result = await response.json();
            if (result.error) {
                alert(result.error);
            } else {
                alert(result.status);
            }
        }
        
        async function getAssignments() {
            document.getElementById('loading').style.display = 'block'; // Show loading
            document.getElementById('assignments').innerHTML = ''; // Clear previous assignments
            document.getElementById('score').innerText = '';

            try {
                let response = await fetch('/assignments');
                let result = await response.json();

                if (result.error) {
                    alert(result.error);
                } else {
                    assignmentsList = result.assignments_list;
                    currentAssignmentIndex = 0;
                    currentAssignment = assignmentsList[currentAssignmentIndex];
                    displayAssignment(currentAssignment);
                    document.getElementById('acceptButton').style.display = 'block';
                    document.getElementById('retryButton').style.display = 'block';
                }
            } catch (error) {
                alert("Error fetching assignments: " + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none'; // Hide loading
            }
        }

        
        function displayAssignment(assignment) {
            console.log("Displaying assignment:", assignment); // Debugging log
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const shifts = ["07:00-15:00", "15:00-23:00", "23:00-07:00"];
        
            let assignmentsTable = '<table border="1"><thead><tr><th>Shift/Day</th>';
            days.forEach(day => {
                assignmentsTable += `<th>${day}</th>`;
            });
            assignmentsTable += '</tr></thead><tbody>';
        
            shifts.forEach(shift => {
                assignmentsTable += `<tr><td>${shift}</td>`;
                days.forEach(day => {
                    let worker = assignment.assignments[`${day} ${shift}`] || '';
                    if (worker) {
                        assignmentsTable += `<td class="assignment-cell"><span class="${worker.toLowerCase()}">${worker}</span></td>`;
                    } else {
                        assignmentsTable += `<td class="assignment-cell"></td>`;
                    }
                });
                assignmentsTable += '</tr>';
            });
            assignmentsTable += '</tbody></table>';
        
            document.getElementById('assignments').innerHTML = assignmentsTable;
            document.getElementById('score').innerText = 'Score: ' + assignment.score;
        }
        
        async function retryAssignment() {
            currentAssignmentIndex++; // Move to the next assignment
            if (currentAssignmentIndex < assignmentsList.length) {
                currentAssignment = assignmentsList[currentAssignmentIndex]; // Update currentAssignment to the next one
                console.log("Retrying with assignment:", currentAssignment); // Debugging log
                displayAssignment(currentAssignment); // Display the next best assignment
            } else {
                // If no more assignments are available, regenerate new assignments
                alert("No more alternate assignments. Generating new assignments...");
                await getAssignments(); // Fetch a new list of assignments
            }
        }
        
        async function acceptAssignment() {
            if (!currentAssignment) {
                alert("No assignment to accept.");
                return;
            }
        
            console.log("Accepting assignment:", assignmentsList[currentAssignmentIndex]); // Debugging log before sending
        
            let response = await fetch('/assignments/accept', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(assignmentsList[currentAssignmentIndex])
            });
        
            let result = await response.json();
            if (result.success) {
                alert("Assignment accepted and saved!");
                document.getElementById('assignments').innerHTML = ''; // Clear the assignment
                document.getElementById('score').innerText = '';
                document.getElementById('acceptButton').style.display = 'none'; // Hide accept button
                document.getElementById('retryButton').style.display = 'none'; // Hide retry button
                currentAssignment = null; // Reset the assignment
                assignmentsList = []; // Clear the list of assignments
            } else {
                alert("Error: " + result.error);
            }
        }
        </script>        
        
</head>
<body>
    <h1>Shift Availability</h1>
    <form onsubmit="event.preventDefault(); submitAvailability();">
        <script>
            const workers = ["Worker1", "Worker2", "Worker3", "Worker4", "Worker5", "Worker6", "Worker7"];
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const shifts = ["07:00-15:00", "15:00-23:00", "23:00-07:00"];
            
            workers.forEach(worker => {
                document.write(`<h2 class="worker-title ${worker.toLowerCase()}">${worker}</h2>`);
                document.write('<table border="1"><thead><tr><th>Shift/Day</th>');
                days.forEach(day => {
                    document.write(`<th>${day}</th>`);
                });
                document.write('</tr></thead><tbody>');
                shifts.forEach(shift => {
                    document.write(`<tr><td>${shift}</td>`);
                    days.forEach(day => {
                        document.write(`<td><input type="checkbox" id="${worker}_${day}_${shift}" class="availability"></td>`);
                    });
                    document.write('</tr>');
                });
                document.write('</tbody></table>');
            });
        </script>
        <button type="submit">Submit Availability</button>
    </form>
    <button onclick="getAssignments()">Get Assignments</button>
    <button id="acceptButton" onclick="acceptAssignment()" style="display:none;">Accept Assignment</button>
    <button id="retryButton" onclick="retryAssignment()" style="display:none;">Retry</button>
    <div id="loading" style="display:none;">Loading...</div>


    <h2>Assignments</h2>
    <div id="assignments"></div>
    <p id="score"></p>
</body>
</html>
